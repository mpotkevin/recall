<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»¶é²è¨˜æ†¶ç‹ - è·èƒ½æ²»ç™‚å¸« é„­å‡±æ–‡è¨­è¨ˆ</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-12px); } 75% { transform: translateX(12px); } }
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const INITIAL_WORD_SETS = [
            { category: "å®¢å»³èˆ‡å±…å®¶", items: [
                { id: 'l1', name: 'é›»è¦–', icon: 'ğŸ“º' }, { id: 'l2', name: 'æ²™ç™¼', icon: 'ğŸ›‹ï¸' }, { id: 'l3', name: 'é™æ§å™¨', icon: 'ğŸ•¹ï¸' },
                { id: 'l4', name: 'é›»é¢¨æ‰‡', icon: 'ğŸŒ€' }, { id: 'l5', name: 'é›»è©±', icon: 'â˜ï¸' }, { id: 'l6', name: 'èŒ¶å‡ ', icon: 'ğŸµ' },
                { id: 'l7', name: 'æ™‚é˜', icon: 'â°' }, { id: 'l8', name: 'å ±ç´™', icon: 'ğŸ“°' }, { id: 'l9', name: 'æª¯ç‡ˆ', icon: 'ğŸ’¡' }, { id: 'l10', name: 'å†·æ°£', icon: 'â„ï¸' }
            ]},
            { category: "å»šæˆ¿èˆ‡é£²é£Ÿ", items: [
                { id: 'k1', name: 'æ¹¯åŒ™', icon: 'ğŸ¥„' }, { id: 'k2', name: 'ç­·å­', icon: 'ğŸ¥¢' }, { id: 'k3', name: 'ç¢—å…¬', icon: 'ğŸ¥£' },
                { id: 'k4', name: 'å‰å­', icon: 'ğŸ´' }, { id: 'k5', name: 'ç³–æœ', icon: 'ğŸ¬' }, { id: 'k6', name: 'ç›¤å­', icon: 'ğŸ½ï¸' },
                { id: 'k7', name: 'é›»é‹', icon: 'ğŸš' }, { id: 'k8', name: 'èœåˆ€', icon: 'ğŸ”ª' }, { id: 'k9', name: 'æ°´å£º', icon: 'ğŸ¶' }, { id: 'k10', name: 'å†°ç®±', icon: 'ğŸ§Š' }
            ]},
            { category: "è‡¥å®¤ç”¨å“", items: [
                { id: 'b1', name: 'æ•é ­', icon: 'ğŸ’¤' }, { id: 'b2', name: 'æ£‰è¢«', icon: 'ğŸ›Œ' }, { id: 'b3', name: 'åºŠå¢Š', icon: 'ğŸ›ï¸' },
                { id: 'b4', name: 'è¡£æ«ƒ', icon: 'ğŸšª' }, { id: 'b5', name: 'æ¢³å­', icon: 'ğŸª®' }, { id: 'b6', name: 'é¡å­', icon: 'ğŸª' },
                { id: 'b7', name: 'ç¡è¡£', icon: 'ğŸ‘•' }, { id: 'b8', name: 'é¬§é˜', icon: 'ğŸ””' }, { id: 'b9', name: 'æ‹–é‹', icon: 'ğŸ©´' }, { id: 'b10', name: 'çª—ç°¾', icon: 'ğŸ–¼ï¸' }
            ]},
            { category: "å¤–å‡ºå¿…å‚™", items: [
                { id: 'o1', name: 'é›¨å‚˜', icon: 'ğŸŒ‚' }, { id: 'o2', name: 'å¸½å­', icon: 'ğŸ‘’' }, { id: 'o3', name: 'å£ç½©', icon: 'ğŸ˜·' },
                { id: 'o4', name: 'é‘°åŒ™', icon: 'ğŸ”‘' }, { id: 'o5', name: 'éŒ¢åŒ…', icon: 'ğŸ‘›' }, { id: 'o6', name: 'æ‰‹æ©Ÿ', icon: 'ğŸ“±' },
                { id: 'o7', name: 'è‡ªè¡Œè»Š', icon: 'ğŸš²' }, { id: 'o8', name: 'å…¬è»Š', icon: 'ğŸšŒ' }, { id: 'o9', name: 'æ‚ éŠå¡', icon: 'ğŸ’³' }, { id: 'o10', name: 'æ‰‹é›»ç­’', icon: 'ğŸ”¦' }
            ]},
            { category: "ä¼‘é–’èˆˆè¶£", items: [
                { id: 'h1', name: 'è±¡æ£‹', icon: 'â™Ÿï¸' }, { id: 'h2', name: 'æ’²å…‹ç‰Œ', icon: 'ğŸƒ' }, { id: 'h3', name: 'æ”¶éŸ³æ©Ÿ', icon: 'ğŸ“»' },
                { id: 'h4', name: 'ç›†æ ½', icon: 'ğŸª´' }, { id: 'h5', name: 'é­šç«¿', icon: 'ğŸ£' }, { id: 'h6', name: 'ç›¸æ©Ÿ', icon: 'ğŸ“·' },
                { id: 'h7', name: 'æ¯›ç·š', icon: 'ğŸ§¶' }, { id: 'h8', name: 'é‹¼ç´', icon: 'ğŸ¹' }, { id: 'h9', name: 'æ¯›ç­†', icon: 'ğŸ–Œï¸' }, { id: 'h10', name: 'æ”¾å¤§é¡', icon: 'ğŸ”' }
            ]}
        ];

        const STAGES = { START: 'START', MEMORIZE: 'MEMORIZE', DISTRACT: 'DISTRACT', RECALL: 'RECALL', RESULT: 'RESULT', HISTORY: 'HISTORY' };

        const COLORS = [
            { name: 'ç´…è‰²', color: '#ef4444' }, 
            { name: 'è—è‰²', color: '#3b82f6' },
            { name: 'ç¶ è‰²', color: '#22c55e' }, 
            { name: 'é»ƒè‰²', color: '#F2CD13' }, 
            { name: 'ç´«è‰²', color: '#a855f7' }, 
            { name: 'æ©˜è‰²', color: '#f97316' },
            { name: 'ç²‰è‰²', color: '#f472b6' }, 
            { name: 'æ£•è‰²', color: '#92400e' },
            { name: 'é»‘è‰²', color: '#000000' }, 
            { name: 'ç°è‰²', color: '#94a3b8' }
        ];

        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [stage, setStage] = useState(STAGES.START);
            const [wordLibrary, setWordLibrary] = useState(INITIAL_WORD_SETS);
            const [currentSet, setCurrentSet] = useState(null);
            const [targets, setTargets] = useState([]);
            const [options, setOptions] = useState([]);
            const [selections, setSelections] = useState([]);
            const [distractorTask, setDistractorTask] = useState({ word: '', color: '', isMatch: false });
            const [showPool, setShowPool] = useState(false);
            const [showAbortModal, setShowAbortModal] = useState(false); 
            const [lastFeedback, setLastFeedback] = useState(null);
            const [score, setScore] = useState(0);
            const [viewingRecord, setViewingRecord] = useState(null);

            const distractorHistory = useRef({ matchCount: 0, mismatchCount: 0 });
            const [timerLeft, setTimerLeft] = useState(0);
            const [memoryStopwatch, setMemoryStopwatch] = useState(0); 
            
            const [stats, setStats] = useState({
                startTime: 0, endTime: 0, memoryTime: 0,
                distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, 
                reactionTimes: [], lastActionTime: 0
            });

            const [practiceHistory, setPracticeHistory] = useState([]);
            const [newItem, setNewItem] = useState({ name: '', category: 'å®¢å»³èˆ‡å±…å®¶' });

            const [config, setConfig] = useState({
                targetCount: 3, distractorMode: 'count', distractorTarget: 5, distractorDuration: 30, recallDistractorCount: 3, showIcons: false
            });

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const updateConfig = (key, val) => setConfig(prev => ({ ...prev, [key]: val }));

            const resetAllStates = () => {
                setStage(STAGES.START);
                setViewingRecord(null);
                setTargets([]);
                setSelections([]);
                setOptions([]);
                setLastFeedback(null);
                setMemoryStopwatch(0);
                setTimerLeft(0);
                setStats({
                    startTime: 0, endTime: 0, memoryTime: 0,
                    distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, 
                    reactionTimes: [], lastActionTime: 0
                });
                setShowAbortModal(false);
            };

            const confirmAbort = () => {
                setShowAbortModal(true);
            };

            const startGame = () => {
                const availableCategories = wordLibrary.filter(c => c.items.length >= config.targetCount);
                if (availableCategories.length === 0) return alert("é¡Œåº«å…§å®¹ä¸è¶³ï¼");
                const randomSet = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                const shuffledItems = [...randomSet.items].sort(() => 0.5 - Math.random());
                const targetItems = shuffledItems.slice(0, config.targetCount);
                
                setCurrentSet(randomSet);
                setTargets(targetItems);
                setSelections([]);
                setLastFeedback(null);
                setScore(0);
                setViewingRecord(null);
                setMemoryStopwatch(0); 
                
                setStats({ 
                    startTime: Date.now(), 
                    endTime: 0, 
                    memoryTime: 0,
                    distractorTotal: 0, 
                    distractorCorrect: 0, 
                    distractorWrong: 0, 
                    reactionTimes: [], 
                    lastActionTime: 0 
                });
                
                distractorHistory.current = { matchCount: 0, mismatchCount: 0 };
                setStage(STAGES.MEMORIZE);
            };

            useEffect(() => {
                let mInterval;
                if (stage === STAGES.MEMORIZE) {
                    mInterval = setInterval(() => {
                        setMemoryStopwatch(prev => prev + 1);
                    }, 1000);
                }
                return () => clearInterval(mInterval);
            }, [stage]);

            const finishMemorize = () => {
                setStats(prev => ({ ...prev, memoryTime: memoryStopwatch }));
                setStage(STAGES.DISTRACT);
            };

            const nextDistractor = useCallback(() => {
                const history = distractorHistory.current;
                let shouldMatch;
                if (history.matchCount > history.mismatchCount + 1) shouldMatch = false;
                else if (history.mismatchCount > history.matchCount + 1) shouldMatch = true;
                else shouldMatch = Math.random() > 0.5;
                const wordObj = COLORS[Math.floor(Math.random() * COLORS.length)];
                let colorObj;
                if (shouldMatch) {
                    colorObj = wordObj;
                    history.matchCount++;
                } else {
                    const otherColors = COLORS.filter(c => c.name !== wordObj.name);
                    colorObj = otherColors[Math.floor(Math.random() * otherColors.length)];
                    history.mismatchCount++;
                }
                setDistractorTask({ word: wordObj.name, color: colorObj.color, isMatch: shouldMatch });
                setStats(prev => ({ ...prev, lastActionTime: Date.now() }));
            }, []);

            const handleDistractorAnswer = (answer) => {
                const isCorrect = answer === distractorTask.isMatch;
                const now = Date.now();
                const reactionTime = now - stats.lastActionTime;
                setStats(prev => ({
                    ...prev,
                    distractorTotal: prev.distractorTotal + 1,
                    distractorCorrect: isCorrect ? prev.distractorCorrect + 1 : prev.distractorCorrect,
                    distractorWrong: !isCorrect ? prev.distractorWrong + 1 : prev.distractorWrong,
                    reactionTimes: [...prev.reactionTimes, reactionTime]
                }));
                if (isCorrect) {
                    setLastFeedback('correct');
                    const currentCorrect = stats.distractorCorrect + 1;
                    if (config.distractorMode === 'count' && currentCorrect >= config.distractorTarget) {
                        setTimeout(() => prepareRecall(), 400);
                    } else {
                        setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 400);
                    }
                } else {
                    setLastFeedback('wrong');
                    setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 600);
                }
            };

            useEffect(() => {
                let timer;
                if (stage === STAGES.DISTRACT && config.distractorMode === 'time') {
                    setTimerLeft(config.distractorDuration);
                    timer = setInterval(() => {
                        setTimerLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                prepareRecall();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [stage, config.distractorMode, config.distractorDuration]);

            const prepareRecall = () => {
                const distractorsPool = currentSet.items.filter(item => !targets.some(t => t.id === item.id));
                const selectedDistractors = [...distractorsPool].sort(() => 0.5 - Math.random()).slice(0, config.recallDistractorCount);
                const combined = [...targets, ...selectedDistractors].sort(() => 0.5 - Math.random());
                setOptions(combined);
                setStage(STAGES.RECALL);
            };

            const toggleSelection = (item) => {
                if (selections.find(s => s.id === item.id)) {
                    setSelections(selections.filter(s => s.id !== item.id));
                } else if (selections.length < targets.length) {
                    setSelections([...selections, item]);
                }
            };

            const finishGame = () => {
                const correctCount = selections.filter(s => targets.find(t => t.id === s.id)).length;
                const finalStats = { ...stats, endTime: Date.now(), finalScore: correctCount };
                setScore(correctCount);
                const record = {
                    id: Date.now(), date: new Date().toLocaleString(), config: { ...config },
                    targetItems: targets.map(t => ({ name: t.name, icon: t.icon, id: t.id })),
                    stats: finalStats,
                    selections: selections.map(s => ({ id: s.id, name: s.name, icon: s.icon, isCorrect: targets.some(t => t.id === s.id) }))
                };
                setPracticeHistory(prev => [record, ...prev]);
                setStage(STAGES.RESULT);
            };

            const showHistoryRecord = (record) => {
                setViewingRecord(record);
                setStage(STAGES.RESULT);
            };

            const handleDeleteItem = (categoryId, itemId) => {
                setWordLibrary(prev => prev.map(cat => (cat.category === categoryId ? { ...cat, items: cat.items.filter(item => item.id !== itemId) } : cat)));
            };

            const handleAddNewItem = (e) => {
                e.preventDefault();
                if (!newItem.name.trim()) return;
                const itemToAdd = { id: `custom-${Date.now()}`, name: newItem.name, icon: 'ğŸ“¦' };
                setWordLibrary(prev => prev.map(cat => cat.category === newItem.category ? { ...cat, items: [itemToAdd, ...cat.items] } : cat));
                setNewItem({ ...newItem, name: '' });
            };

            useEffect(() => { if (stage === STAGES.DISTRACT) nextDistractor(); }, [stage, nextDistractor]);

            const currentDisplay = viewingRecord ? {
                score: viewingRecord.stats.finalScore, targets: viewingRecord.targetItems, stats: viewingRecord.stats,
                config: viewingRecord.config, selections: viewingRecord.selections, date: viewingRecord.date
            } : {
                score: score, targets: targets, stats: stats, config: config, selections: selections, date: new Date().toLocaleString()
            };

            // åæ‡‰æ™‚é–“è¨ˆç®—è¼”åŠ© (ms -> s)
            const getAverageReactionTime = (rTimes) => {
                if (!rTimes || rTimes.length === 0) return "0.000";
                const avgMs = rTimes.reduce((a, b) => a + b, 0) / rTimes.length;
                return (avgMs / 1000).toFixed(3);
            };

            return (
                <div className="min-h-screen p-2 md:p-8">
                    <div className="max-w-3xl mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden relative border border-slate-100">
                        
                        {/* Header */}
                        <div className="bg-white border-b border-slate-100 p-6 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-100">
                                    <Icon name="brain" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight text-slate-900">å»¶é²è¨˜æ†¶ç‹</h1>
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Cognitive Mastery Pro</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                {(stage === STAGES.MEMORIZE || stage === STAGES.DISTRACT || stage === STAGES.RECALL) && (
                                    <button onClick={confirmAbort} className="flex items-center gap-2 bg-red-50 text-red-500 hover:bg-red-100 px-4 py-2.5 rounded-xl text-sm font-bold transition-all border border-red-100 mr-2 shadow-sm">
                                        <Icon name="octagon-x" size={20} /> ä¸­æ–·è¨“ç·´
                                    </button>
                                )}
                                <button onClick={() => setStage(STAGES.HISTORY)} className="p-2.5 bg-slate-50 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-all border border-slate-100">
                                    <Icon name="history" size={22} />
                                </button>
                                <button onClick={() => setShowPool(true)} className="flex items-center gap-2 bg-slate-50 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 px-4 py-2.5 rounded-xl text-sm font-bold transition-all border border-slate-100">
                                    <Icon name="package" size={20} /> ç®¡ç†é¡Œåº«
                                </button>
                            </div>
                        </div>

                        <div className="p-6 md:p-10">
                            {stage === STAGES.START && (
                                <div className="animate-in fade-in zoom-in duration-500 text-center">
                                    <div className="mb-10">
                                        <div className="inline-block mb-4 px-4 py-1 bg-indigo-50 text-indigo-600 rounded-full text-sm font-black">DAILY TRAINING</div>
                                        <h2 className="text-4xl font-black text-slate-900 mb-2">æº–å‚™é–‹å§‹è¨“ç·´</h2>
                                        <p className="text-slate-400">å®¢è£½åŒ–æ‚¨çš„èªçŸ¥æŒ‘æˆ°æ¨¡å¼</p>
                                    </div>
                                    <div className="space-y-4 mb-10 max-w-xl mx-auto">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-slate-50/50 p-6 rounded-[2.5rem] border-2 border-slate-100 flex flex-col items-center">
                                                <div className="flex items-center gap-2 mb-4 text-indigo-500"><Icon name="target" size={20} /><span className="text-sm font-black text-slate-500 uppercase">ç‰©å“è¨˜æ†¶</span></div>
                                                <div className="flex items-center gap-5">
                                                    <button onClick={() => updateConfig('targetCount', Math.max(1, config.targetCount - 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="minus" size={18} /></button>
                                                    <span className="text-xl font-black min-w-[32px] text-center">{config.targetCount}</span>
                                                    <button onClick={() => updateConfig('targetCount', Math.min(10, config.targetCount + 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="plus" size={18} /></button>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50/50 p-6 rounded-[2.5rem] border-2 border-slate-100 flex flex-col items-center">
                                                <div className="flex items-center gap-2 mb-4 text-amber-500"><Icon name="layers" size={20} /><span className="text-sm font-black text-slate-500 uppercase">å›æ†¶æ··æ·†</span></div>
                                                <div className="flex items-center gap-5">
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.max(0, config.recallDistractorCount - 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="minus" size={18} /></button>
                                                    <span className="text-xl font-black min-w-[32px] text-center">{config.recallDistractorCount}</span>
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.min(15, config.recallDistractorCount + 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="plus" size={18} /></button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-50/50 p-6 rounded-[2rem] border-2 border-slate-100">
                                            <div className="flex justify-between items-center mb-5">
                                                <div className="flex items-center gap-2"><Icon name="zap" size={18} className="text-indigo-600" /><span className="text-lg font-black text-slate-700">ä»»å‹™åˆ‡æ›æ¨¡å¼</span></div>
                                                <div className="flex bg-slate-200 p-1 rounded-xl">
                                                    <button onClick={() => updateConfig('distractorMode', 'count')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition-all ${config.distractorMode === 'count' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-50'}`}>æ¬¡æ•¸é”æ¨™</button>
                                                    <button onClick={() => updateConfig('distractorMode', 'time')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition-all ${config.distractorMode === 'time' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>è¨ˆæ™‚æŒ‘æˆ°</button>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-center py-2">
                                                <div className="flex items-center gap-8">
                                                    <span className="text-sm font-bold text-slate-400 uppercase">{config.distractorMode === 'count' ? 'ç›®æ¨™æ­£ç¢ºé¡Œæ•¸' : 'æŒ‘æˆ°ç§’æ•¸'}</span>
                                                    <div className="flex items-center gap-5">
                                                        <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.max(1, config.distractorTarget - 1)) : updateConfig('distractorDuration', Math.max(10, config.distractorDuration - 10))} className="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="minus" size={20} /></button>
                                                        <span className="text-3xl font-black min-w-[50px] text-center text-indigo-700">{config.distractorMode === 'count' ? config.distractorTarget : config.distractorDuration}</span>
                                                        <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.min(50, config.distractorTarget + 1)) : updateConfig('distractorDuration', Math.min(120, config.distractorDuration + 10))} className="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="plus" size={20} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateConfig('showIcons', !config.showIcons)} className={`w-full p-5 rounded-[2rem] border-2 transition-all flex items-center justify-between ${config.showIcons ? 'bg-indigo-50/50 border-indigo-100 text-indigo-700' : 'bg-slate-50/50 border-slate-100 text-slate-400'}`}>
                                            <div className="flex items-center gap-3"><Icon name={config.showIcons ? "eye" : "eye-off"} size={22}/><span className="text-lg font-black">åœ–ç‰‡è¼”åŠ©æ¨¡å¼</span></div>
                                            <div className={`w-12 h-6 rounded-full relative transition-colors ${config.showIcons ? 'bg-indigo-600' : 'bg-slate-300'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${config.showIcons ? 'left-7' : 'left-1'}`}></div></div>
                                        </button>
                                    </div>
                                    <button onClick={startGame} className="w-full max-w-xl mx-auto block bg-slate-900 hover:bg-black text-white text-xl font-black py-6 rounded-[2.5rem] shadow-2xl transition-all active:scale-95 group">
                                        <div className="flex items-center justify-center gap-2">å•Ÿå‹•è¨“ç·´å¤§è…¦ <Icon name="arrow-right" className="group-hover:translate-x-2 transition-transform" /></div>
                                    </button>
                                </div>
                            )}

                            {stage === STAGES.MEMORIZE && (
                                <div className="animate-in slide-in-from-right duration-500 text-center">
                                    <div className="mb-8">
                                        <div className="inline-block px-6 py-2 bg-indigo-50 border-2 border-indigo-100 rounded-3xl mb-4 shadow-sm">
                                            <div className="flex items-center gap-3 text-indigo-600 font-mono text-2xl font-black">
                                                <Icon name="timer" /> {memoryStopwatch} ç§’
                                            </div>
                                        </div>
                                        <h3 className="text-3xl font-black text-slate-900 mb-2">ç¬¬ä¸€éšæ®µï¼šè«‹è¨˜ä½ä»¥ä¸‹ç‰©å“</h3>
                                        <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-slate-100 rounded-full text-slate-500 font-bold text-sm">
                                            <Icon name="package" size={16}/> ç•¶å‰é¡åˆ¥ï¼š{currentSet?.category}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-6 mb-12">
                                        {targets.map(item => (
                                            <div key={item.id} className="bg-white border-2 border-slate-100 rounded-[2.5rem] p-6 text-center shadow-sm flex flex-col items-center justify-center min-h-[180px]">
                                                {config.showIcons && <div className="text-6xl mb-4">{item.icon}</div>}
                                                <div className={`font-black text-slate-800 ${config.showIcons ? 'text-2xl' : 'text-4xl'}`}>{item.name}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={finishMemorize} className="w-full bg-indigo-600 text-white text-2xl font-black py-6 rounded-[2rem] shadow-xl active:scale-95 transition-all">
                                        è¨˜å¥½äº†ï¼Œé€²å…¥ä¸‹ä¸€å€‹æŒ‘æˆ°
                                    </button>
                                </div>
                            )}

                            {stage === STAGES.DISTRACT && (
                                <div className="text-center animate-in fade-in duration-300">
                                    <div className="flex justify-center mb-12">
                                        <div className={`px-8 py-3 bg-white border-2 rounded-3xl text-2xl font-black shadow-sm ${config.distractorMode === 'count' ? 'border-amber-200 text-amber-600' : 'border-red-200 text-red-500'}`}>
                                            {config.distractorMode === 'count' ? `å·²ç­”å°ï¼š${stats.distractorCorrect} / ${config.distractorTarget}` : `å‰©é¤˜æ™‚é–“ï¼š${timerLeft} ç§’`}
                                        </div>
                                    </div>
                                    <h3 className="text-2xl font-black mb-8 text-slate-400 uppercase tracking-widest">æ–‡å­—å…§å®¹ èˆ‡ é¡è‰² æ˜¯å¦ä¸€è‡´ï¼Ÿ</h3>
                                    <div className={`mb-12 py-24 bg-white rounded-[4rem] border-4 transition-all relative shadow-inner ${lastFeedback === 'correct' ? 'border-green-400 bg-green-50/30' : lastFeedback === 'wrong' ? 'border-red-400 bg-red-50/30 shake' : 'border-slate-50'}`}>
                                        <span className="text-[7.5rem] font-black tracking-widest" style={{ color: distractorTask.color }}>{distractorTask.word}</span>
                                        {lastFeedback === 'correct' && <div className="absolute top-10 right-10 text-green-500 animate-in zoom-in"><Icon name="check-circle-2" size={64} /></div>}
                                        {lastFeedback === 'wrong' && <div className="absolute top-10 right-10 text-red-500 animate-in zoom-in"><Icon name="x" size={64} /></div>}
                                    </div>
                                    <div className="grid grid-cols-2 gap-10 max-w-2xl mx-auto">
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(true)} className="bg-green-500 hover:bg-green-600 text-white py-10 rounded-[3rem] text-5xl font-black shadow-lg active:scale-95 disabled:opacity-50 transition-all">æ˜¯</button>
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(false)} className="bg-red-500 hover:bg-red-600 text-white py-10 rounded-[3rem] text-5xl font-black shadow-lg active:scale-95 disabled:opacity-50 transition-all">å¦</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.RECALL && (
                                <div className="animate-in fade-in duration-500 text-center">
                                    <h3 className="text-3xl font-black text-slate-900 mb-8">ç¬¬ä¸‰éšæ®µï¼šå»¶é²å›æ†¶æŒ‘æˆ°</h3>
                                    <div className="flex justify-center mb-10">
                                        <div className="px-10 py-4 bg-indigo-600 text-white rounded-[2rem] font-black text-3xl shadow-xl ring-8 ring-indigo-50">{selections.length} / {targets.length}</div>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-5 mb-12">
                                        {options.map(item => {
                                            const isSelected = selections.find(s => s.id === item.id);
                                            return (
                                                <button key={item.id} onClick={() => toggleSelection(item)} className={`relative p-6 rounded-[2.5rem] border-2 transition-all flex flex-col items-center justify-center ${isSelected ? 'border-indigo-500 bg-indigo-50/50 scale-95 shadow-inner' : 'border-slate-100 bg-white hover:border-slate-200 shadow-sm'} ${config.showIcons ? 'h-44' : 'h-32'}`}>
                                                    {config.showIcons && <div className="text-5xl mb-2">{item.icon}</div>}
                                                    <div className={`font-black text-slate-700 ${config.showIcons ? 'text-xl' : 'text-2xl'}`}>{item.name}</div>
                                                    {isSelected && <div className="absolute top-4 right-4 bg-indigo-500 text-white rounded-full p-1 shadow-md"><Icon name="check-circle-2" size={24} /></div>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <button onClick={finishGame} disabled={selections.length < targets.length} className={`w-full py-6 rounded-[2.5rem] text-2xl font-black shadow-2xl active:scale-95 transition-all ${selections.length < targets.length ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-900 text-white hover:bg-black'}`}>{selections.length < targets.length ? `é‚„å·® ${targets.length - selections.length} å€‹ç­”æ¡ˆ` : 'å®Œæˆè¨“ç·´ï¼ŒæŸ¥çœ‹åˆ†æå ±å‘Š'}</button>
                                </div>
                            )}

                            {stage === STAGES.RESULT && (
                                <div className="animate-in zoom-in duration-500 text-center">
                                    <div className="mb-10">
                                        <div className="inline-block p-4 bg-slate-50 border rounded-3xl text-indigo-600 mb-4 shadow-sm"><Icon name="file-text" size={40}/></div>
                                        <h3 className="text-4xl font-black text-slate-900">è¨“ç·´å ±å‘Š</h3>
                                        <p className="text-slate-400 font-bold">{currentDisplay.date}</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                                        <div className="bg-white rounded-[3rem] p-10 border-2 border-slate-50 shadow-sm text-center flex flex-col justify-center">
                                            <p className="text-slate-400 font-black mb-2 uppercase text-sm">å›æ†¶æº–ç¢ºç‡</p>
                                            <div className="text-[6rem] font-black text-slate-900 leading-none mb-6">{Math.round((currentDisplay.score / currentDisplay.targets.length) * 100)}<span className="text-2xl ml-1">%</span></div>
                                            <div className="flex justify-center gap-3">{currentDisplay.targets.map((t, idx) => (<div key={idx} className={`w-4 h-4 rounded-full ${currentDisplay.selections.some(s => s.id === t.id) ? 'bg-green-500' : 'bg-red-400'}`}></div>))}</div>
                                        </div>
                                        <div className="bg-indigo-600 rounded-[3rem] p-10 text-white shadow-xl space-y-5 flex flex-col justify-center text-left">
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>1. ç‰©å“è¨˜æ†¶è€—æ™‚</span><span className="font-bold text-xl">{currentDisplay.stats.memoryTime} ç§’</span></div>
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>2. å¹²æ“¾ç­”å°é¡Œæ•¸</span><span className="font-bold text-xl">{currentDisplay.stats.distractorCorrect} é¡Œ</span></div>
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>ä»»å‹™æ­£ç¢ºç‡</span><span className="font-bold">{Math.round((currentDisplay.stats.distractorCorrect / currentDisplay.stats.distractorTotal) * 100 || 0)}%</span></div>
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>å¹³å‡åæ‡‰æ™‚é–“</span><span className="font-bold">{getAverageReactionTime(currentDisplay.stats.reactionTimes)} ç§’</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 rounded-[2.5rem] p-8 mb-10 text-left">
                                        <div className="font-black text-slate-800 mb-6 px-2">è¨˜æ†¶ç‰©ä»¶æ¸…å–® (ç›®æ¨™é …)</div>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                            {currentDisplay.targets.map(t => (
                                                <div key={t.id} className="flex items-center gap-3 px-5 py-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                                    <span className="text-3xl">{t.icon}</span>
                                                    <div className="flex-1 font-black text-slate-700 truncate">{t.name}</div>
                                                    {currentDisplay.selections.some(s => s.id === t.id) ? <Icon name="check-circle-2" className="text-green-500" /> : <Icon name="x" className="text-red-400" />}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => { setViewingRecord(null); setStage(STAGES.START); }} className="flex-1 bg-slate-900 text-white py-6 rounded-3xl text-xl font-black shadow-xl active:scale-95 transition-all">å›åˆ°ä¸»ç•«é¢</button>
                                        <button onClick={() => setStage(STAGES.HISTORY)} className="flex-1 bg-white border-2 border-slate-100 text-slate-600 py-6 rounded-3xl text-xl font-black shadow-md transition-all">æ­·å²æˆç¸¾</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.HISTORY && (
                                <div className="animate-in fade-in duration-400">
                                    <div className="flex justify-between items-center mb-10"><h3 className="text-3xl font-black text-slate-900 flex items-center gap-4"><Icon name="history" size={32} className="text-indigo-600" /> è¨“ç·´æ­·å²ç´€éŒ„</h3><button onClick={() => setStage(STAGES.START)}><Icon name="x" size={36} className="text-slate-400 hover:text-slate-600 transition-colors"/></button></div>
                                    <div className="space-y-4 max-h-[500px] overflow-y-auto pr-3 custom-scrollbar">
                                        {practiceHistory.length === 0 ? <div className="text-center py-24 bg-slate-50 rounded-[3rem] border-2 border-dashed border-slate-200 text-slate-400 font-black">ç›®å‰å°šç„¡æ•¸æ“š</div> : 
                                            practiceHistory.map(record => (
                                                <button key={record.id} onClick={() => showHistoryRecord(record)} className="w-full bg-white border-2 border-slate-50 p-6 rounded-[2rem] flex justify-between items-center hover:border-indigo-300 transition-all text-left shadow-sm group">
                                                    <div><div className="text-xs font-black text-slate-300 uppercase">{record.date}</div><div className="text-xl font-black text-slate-800 group-hover:text-indigo-700 transition-colors">è¨˜æ†¶ {record.config.targetCount} é …æŒ‘æˆ°</div><div className="text-sm text-slate-400">è¨˜æ†¶è€—æ™‚ï¼š{record.stats.memoryTime} ç§’</div></div>
                                                    <div className="flex items-center gap-6"><div className="text-right"><div className="text-4xl font-black text-indigo-600">{Math.round((record.stats.finalScore / record.config.targetCount) * 100)}%</div></div><Icon name="chevron-right" className="text-slate-200 group-hover:text-indigo-400 transition-all" size={28} /></div>
                                                </button>
                                            ))
                                        }
                                    </div>
                                    <button onClick={() => setStage(STAGES.START)} className="w-full mt-10 bg-slate-900 text-white py-6 rounded-[2rem] font-black text-xl hover:bg-black transition-all">å›åˆ°ä¸»ç•«é¢</button>
                                </div>
                            )}
                        </div>

                        {/* Footer info */}
                        <div className="bg-slate-50 p-6 border-t border-slate-100 flex flex-col items-center gap-4">
                            <div className="flex justify-center gap-6 text-slate-400 text-[10px] font-black uppercase tracking-widest">
                                <div className="flex items-center gap-1"><Icon name="home" size={12}/> Living</div>
                                <div className="flex items-center gap-1"><Icon name="brain" size={12}/> Memory</div>
                                <div className="flex items-center gap-1"><Icon name="eye" size={12}/> Cognitive</div>
                            </div>
                            <div className="text-slate-400 text-xs font-bold border-t border-slate-200 pt-4 w-full text-center">
                                è¨­è¨ˆï¼š<a href="https://www.facebook.com/mpotkevin" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 transition-colors underline decoration-indigo-200 underline-offset-4 decoration-2 font-bold uppercase tracking-tight">è·èƒ½æ²»ç™‚å¸« - é„­å‡±æ–‡</a>
                            </div>
                        </div>

                        {/* è‡ªå®šç¾©ä¸­æ–·ç¢ºèªå½ˆçª— */}
                        {showAbortModal && (
                            <div className="absolute inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm p-4 flex items-center justify-center animate-in fade-in duration-200">
                                <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl text-center border-2 border-red-50 animate-in zoom-in duration-300">
                                    <div className="w-20 h-20 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <Icon name="alert-triangle" size={40} />
                                    </div>
                                    <h4 className="text-2xl font-black text-slate-800 mb-4">ç¢ºå®šè¦ä¸­æ–·å—ï¼Ÿ</h4>
                                    <p className="text-slate-500 mb-8 font-medium">ä¸­æ–·å¾Œç›®å‰çš„è¨“ç·´é€²åº¦å°‡æœƒéºå¤±ã€‚</p>
                                    <div className="flex gap-4">
                                        <button onClick={() => setShowAbortModal(false)} className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black hover:bg-slate-200 transition-all">ç¹¼çºŒè¨“ç·´</button>
                                        <button onClick={resetAllStates} className="flex-1 py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-100 hover:bg-red-600 transition-all">ç¢ºå®šä¸­æ–·</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* é¡Œåº«å½ˆçª— */}
                        {showPool && (
                            <div className="absolute inset-0 z-50 bg-slate-900/80 backdrop-blur-xl p-4 flex items-center justify-center">
                                <div className="bg-white w-full max-h-[92%] rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in duration-300">
                                    <div className="p-8 bg-slate-50 border-b flex justify-between items-center">
                                        <div className="flex items-center gap-4"><div className="p-3 bg-white rounded-2xl text-indigo-600 shadow-sm"><Icon name="package" size={28} /></div><div><h4 className="text-2xl font-black text-slate-900">è¨“ç·´é¡Œåº«ç®¡ç†</h4></div></div>
                                        <button onClick={() => setShowPool(false)} className="text-slate-400 hover:text-slate-600 transition-colors"><Icon name="x" size={32} /></button>
                                    </div>
                                    <div className="p-8 bg-white border-b">
                                        <form onSubmit={handleAddNewItem} className="flex gap-4">
                                            <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="ä¾‹å¦‚ï¼šæ”¾å¤§é¡..." className="flex-1 p-4 border-2 border-slate-100 rounded-2xl font-bold bg-slate-50/50 outline-none focus:border-indigo-400 transition-all shadow-inner" />
                                            <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} className="p-4 border-2 border-slate-100 rounded-2xl font-bold bg-slate-50/50 text-slate-600 outline-none focus:border-indigo-400 transition-all">
                                                {wordLibrary.map(cat => <option key={cat.category} value={cat.category}>{cat.category}</option>)}
                                            </select>
                                            <button type="submit" className="bg-slate-900 text-white px-8 rounded-2xl font-black hover:bg-black transition-all active:scale-95 shadow-lg">æ–°å¢</button>
                                        </form>
                                    </div>
                                    <div className="p-8 overflow-y-auto space-y-12 bg-slate-50/20 custom-scrollbar">
                                        {wordLibrary.map(set => (
                                            <div key={set.category}>
                                                <h5 className="font-black text-slate-900 mb-6 flex items-center gap-3 text-xl"><div className="w-2.5 h-6 bg-indigo-500 rounded-full"></div>{set.category}</h5>
                                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                                                    {set.items.map(item => (
                                                        <div key={item.id} className="group relative p-5 bg-white rounded-3xl text-center border border-slate-100 flex flex-col items-center shadow-sm hover:border-red-200 transition-all">
                                                            <button onClick={() => handleDeleteItem(set.category, item.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity shadow-md hover:scale-110 active:scale-90"><Icon name="trash-2" size={14} /></button>
                                                            <div className="text-4xl mb-2">{typeof item.icon === 'string' ? item.icon : 'ğŸ“¦'}</div>
                                                            <div className="text-xs font-black text-slate-600 truncate w-full">{item.name}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
