<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âª∂ÈÅ≤Ë®òÊÜ∂Áéã - ËÅ∑ËÉΩÊ≤ªÁôÇÂ∏´ ÈÑ≠Âá±ÊñáË®≠Ë®à</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            overscroll-behavior-y: contain; /* Èò≤Ê≠¢ÊâãÊ©üÁÄèË¶ΩÂô®‰∏ãÊãâÂà∑Êñ∞ÂΩ±ÈüøÈÅäÊà≤È´îÈ©ó */
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Á¢∫‰øùÂÖ®Ëû¢ÂπïÈ´òÂ∫¶‰∏î‰∏çÁî¢ÁîüÂÖ®È†ÅÊªæÂãï */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const INITIAL_WORD_SETS = [
            { category: "ÂÆ¢Âª≥ËàáÂ±ÖÂÆ∂", items: [
                { id: 'l1', name: 'ÈõªË¶ñ', icon: 'üì∫' }, { id: 'l2', name: 'Ê≤ôÁôº', icon: 'üõãÔ∏è' }, { id: 'l3', name: 'ÈÅôÊéßÂô®', icon: 'üïπÔ∏è' },
                { id: 'l4', name: 'ÈõªÈ¢®Êâá', icon: 'üåÄ' }, { id: 'l5', name: 'ÈõªË©±', icon: '‚òéÔ∏è' }, { id: 'l6', name: 'Ëå∂Âá†', icon: 'üçµ' },
                { id: 'l7', name: 'ÊôÇÈêò', icon: '‚è∞' }, { id: 'l8', name: 'Â†±Á¥ô', icon: 'üì∞' }, { id: 'l9', name: 'Ê™ØÁáà', icon: 'üí°' }, { id: 'l10', name: 'ÂÜ∑Ê∞£', icon: '‚ùÑÔ∏è' }
            ]},
            { category: "ÂªöÊàøËàáÈ£≤È£ü", items: [
                { id: 'k1', name: 'ÊπØÂåô', icon: 'ü•Ñ' }, { id: 'k2', name: 'Á≠∑Â≠ê', icon: 'ü•¢' }, { id: 'k3', name: 'Á¢óÂÖ¨', icon: 'ü•£' },
                { id: 'k4', name: 'ÂèâÂ≠ê', icon: 'üç¥' }, { id: 'k5', name: 'Á≥ñÊûú', icon: 'üç¨' }, { id: 'k6', name: 'Áõ§Â≠ê', icon: 'üçΩÔ∏è' },
                { id: 'k7', name: 'ÈõªÈçã', icon: 'üçö' }, { id: 'k8', name: 'ËèúÂàÄ', icon: 'üî™' }, { id: 'k9', name: 'Ê∞¥Â£∫', icon: 'üç∂' }, { id: 'k10', name: 'ÂÜ∞ÁÆ±', icon: 'üßä' }
            ]},
            { category: "Ëá•ÂÆ§Áî®ÂìÅ", items: [
                { id: 'b1', name: 'ÊûïÈ†≠', icon: 'üí§' }, { id: 'b2', name: 'Ê£âË¢´', icon: 'üõå' }, { id: 'b3', name: 'Â∫äÂ¢ä', icon: 'üõèÔ∏è' },
                { id: 'b4', name: 'Ë°£Ê´É', icon: 'üö™' }, { id: 'b5', name: 'Ê¢≥Â≠ê', icon: 'ü™Æ' }, { id: 'b6', name: 'Èè°Â≠ê', icon: 'ü™û' },
                { id: 'b7', name: 'Áù°Ë°£', icon: 'üëï' }, { id: 'b8', name: 'È¨ßÈêò', icon: 'üîî' }, { id: 'b9', name: 'ÊãñÈûã', icon: 'ü©¥' }, { id: 'b10', name: 'Á™óÁ∞æ', icon: 'üñºÔ∏è' }
            ]},
            { category: "Â§ñÂá∫ÂøÖÂÇô", items: [
                { id: 'o1', name: 'Èõ®ÂÇò', icon: 'üåÇ' }, { id: 'o2', name: 'Â∏ΩÂ≠ê', icon: 'üëí' }, { id: 'o3', name: 'Âè£ÁΩ©', icon: 'üò∑' },
                { id: 'o4', name: 'Èë∞Âåô', icon: 'üîë' }, { id: 'o5', name: 'Èå¢ÂåÖ', icon: 'üëõ' }, { id: 'o6', name: 'ÊâãÊ©ü', icon: 'üì±' },
                { id: 'o7', name: 'Ëá™Ë°åËªä', icon: 'üö≤' }, { id: 'o8', name: 'ÂÖ¨Ëªä', icon: 'üöå' }, { id: 'o9', name: 'ÊÇ†ÈÅäÂç°', icon: 'üí≥' }, { id: 'o10', name: 'ÊâãÈõªÁ≠í', icon: 'üî¶' }
            ]},
            { category: "‰ºëÈñíËààË∂£", items: [
                { id: 'h1', name: 'Ë±°Ê£ã', icon: '‚ôüÔ∏è' }, { id: 'h2', name: 'Êí≤ÂÖãÁâå', icon: 'üÉè' }, { id: 'h3', name: 'Êî∂Èü≥Ê©ü', icon: 'üìª' },
                { id: 'h4', name: 'ÁõÜÊ†Ω', icon: 'ü™¥' }, { id: 'h5', name: 'È≠öÁ´ø', icon: 'üé£' }, { id: 'h6', name: 'Áõ∏Ê©ü', icon: 'üì∑' },
                { id: 'h7', name: 'ÊØõÁ∑ö', icon: 'üß∂' }, { id: 'h8', name: 'ÈãºÁê¥', icon: 'üéπ' }, { id: 'h9', name: 'ÊØõÁ≠Ü', icon: 'üñåÔ∏è' }, { id: 'h10', name: 'ÊîæÂ§ßÈè°', icon: 'üîç' }
            ]}
        ];

        const STAGES = { START: 'START', MEMORIZE: 'MEMORIZE', DISTRACT: 'DISTRACT', RECALL: 'RECALL', RESULT: 'RESULT', HISTORY: 'HISTORY' };

        const COLORS = [
            { name: 'Á¥ÖËâ≤', color: '#ef4444' }, 
            { name: 'ËóçËâ≤', color: '#3b82f6' },
            { name: 'Á∂†Ëâ≤', color: '#22c55e' }, 
            { name: 'ÈªÉËâ≤', color: '#F2CD13' }, 
            { name: 'Á¥´Ëâ≤', color: '#a855f7' }, 
            { name: 'Ê©òËâ≤', color: '#f97316' },
            { name: 'Á≤âËâ≤', color: '#f472b6' }, 
            { name: 'Ê£ïËâ≤', color: '#92400e' },
            { name: 'ÈªëËâ≤', color: '#000000' }, 
            { name: 'ÁÅ∞Ëâ≤', color: '#94a3b8' }
        ];

        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [stage, setStage] = useState(STAGES.START);
            const [wordLibrary, setWordLibrary] = useState(INITIAL_WORD_SETS);
            const [currentSet, setCurrentSet] = useState(null);
            const [targets, setTargets] = useState([]);
            const [options, setOptions] = useState([]);
            const [selections, setSelections] = useState([]);
            const [distractorTask, setDistractorTask] = useState({ word: '', color: '', isMatch: false });
            const [showPool, setShowPool] = useState(false);
            const [showAbortModal, setShowAbortModal] = useState(false); 
            const [lastFeedback, setLastFeedback] = useState(null);
            const [score, setScore] = useState(0);
            const [viewingRecord, setViewingRecord] = useState(null);

            const distractorHistory = useRef({ matchCount: 0, mismatchCount: 0 });
            const [timerLeft, setTimerLeft] = useState(0);
            const [memoryStopwatch, setMemoryStopwatch] = useState(0); 
            
            const [stats, setStats] = useState({
                startTime: 0, endTime: 0, memoryTime: 0,
                distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, 
                reactionTimes: [], lastActionTime: 0
            });

            const [practiceHistory, setPracticeHistory] = useState([]);
            const [newItem, setNewItem] = useState({ name: '', category: 'ÂÆ¢Âª≥ËàáÂ±ÖÂÆ∂' });

            const [config, setConfig] = useState({
                targetCount: 3, distractorMode: 'count', distractorTarget: 5, distractorDuration: 30, recallDistractorCount: 3, showIcons: false
            });

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const updateConfig = (key, val) => setConfig(prev => ({ ...prev, [key]: val }));

            const resetAllStates = () => {
                setStage(STAGES.START);
                setViewingRecord(null);
                setTargets([]);
                setSelections([]);
                setOptions([]);
                setLastFeedback(null);
                setMemoryStopwatch(0);
                setTimerLeft(0);
                setStats({
                    startTime: 0, endTime: 0, memoryTime: 0,
                    distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, 
                    reactionTimes: [], lastActionTime: 0
                });
                setShowAbortModal(false);
            };

            const startGame = () => {
                const availableCategories = wordLibrary.filter(c => c.items.length >= config.targetCount);
                if (availableCategories.length === 0) return alert("È°åÂ∫´ÂÖßÂÆπ‰∏çË∂≥ÔºÅ");
                const randomSet = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                const shuffledItems = [...randomSet.items].sort(() => 0.5 - Math.random());
                const targetItems = shuffledItems.slice(0, config.targetCount);
                
                setCurrentSet(randomSet);
                setTargets(targetItems);
                setSelections([]);
                setLastFeedback(null);
                setScore(0);
                setViewingRecord(null);
                setMemoryStopwatch(0); 
                
                setStats({ 
                    startTime: Date.now(), 
                    endTime: 0, 
                    memoryTime: 0,
                    distractorTotal: 0, 
                    distractorCorrect: 0, 
                    distractorWrong: 0, 
                    reactionTimes: [], 
                    lastActionTime: 0 
                });
                
                distractorHistory.current = { matchCount: 0, mismatchCount: 0 };
                setStage(STAGES.MEMORIZE);
            };

            useEffect(() => {
                let mInterval;
                if (stage === STAGES.MEMORIZE) {
                    mInterval = setInterval(() => {
                        setMemoryStopwatch(prev => prev + 1);
                    }, 1000);
                }
                return () => clearInterval(mInterval);
            }, [stage]);

            const finishMemorize = () => {
                setStats(prev => ({ ...prev, memoryTime: memoryStopwatch }));
                setStage(STAGES.DISTRACT);
            };

            const nextDistractor = useCallback(() => {
                const history = distractorHistory.current;
                let shouldMatch;
                if (history.matchCount > history.mismatchCount + 1) shouldMatch = false;
                else if (history.mismatchCount > history.matchCount + 1) shouldMatch = true;
                else shouldMatch = Math.random() > 0.5;
                const wordObj = COLORS[Math.floor(Math.random() * COLORS.length)];
                let colorObj;
                if (shouldMatch) {
                    colorObj = wordObj;
                    history.matchCount++;
                } else {
                    const otherColors = COLORS.filter(c => c.name !== wordObj.name);
                    colorObj = otherColors[Math.floor(Math.random() * otherColors.length)];
                    history.mismatchCount++;
                }
                setDistractorTask({ word: wordObj.name, color: colorObj.color, isMatch: shouldMatch });
                setStats(prev => ({ ...prev, lastActionTime: Date.now() }));
            }, []);

            const handleDistractorAnswer = (answer) => {
                const isCorrect = answer === distractorTask.isMatch;
                const now = Date.now();
                const reactionTime = now - stats.lastActionTime;
                setStats(prev => ({
                    ...prev,
                    distractorTotal: prev.distractorTotal + 1,
                    distractorCorrect: isCorrect ? prev.distractorCorrect + 1 : prev.distractorCorrect,
                    distractorWrong: !isCorrect ? prev.distractorWrong + 1 : prev.distractorWrong,
                    reactionTimes: [...prev.reactionTimes, reactionTime]
                }));
                if (isCorrect) {
                    setLastFeedback('correct');
                    const currentCorrect = stats.distractorCorrect + 1;
                    if (config.distractorMode === 'count' && currentCorrect >= config.distractorTarget) {
                        setTimeout(() => prepareRecall(), 400);
                    } else {
                        setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 400);
                    }
                } else {
                    setLastFeedback('wrong');
                    setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 600);
                }
            };

            useEffect(() => {
                let timer;
                if (stage === STAGES.DISTRACT && config.distractorMode === 'time') {
                    setTimerLeft(config.distractorDuration);
                    timer = setInterval(() => {
                        setTimerLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                prepareRecall();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [stage, config.distractorMode, config.distractorDuration]);

            const prepareRecall = () => {
                const distractorsPool = currentSet.items.filter(item => !targets.some(t => t.id === item.id));
                const selectedDistractors = [...distractorsPool].sort(() => 0.5 - Math.random()).slice(0, config.recallDistractorCount);
                const combined = [...targets, ...selectedDistractors].sort(() => 0.5 - Math.random());
                setOptions(combined);
                setStage(STAGES.RECALL);
            };

            const toggleSelection = (item) => {
                if (selections.find(s => s.id === item.id)) {
                    setSelections(selections.filter(s => s.id !== item.id));
                } else if (selections.length < targets.length) {
                    setSelections([...selections, item]);
                }
            };

            const finishGame = () => {
                const correctCount = selections.filter(s => targets.find(t => t.id === s.id)).length;
                const finalStats = { ...stats, endTime: Date.now(), finalScore: correctCount };
                setScore(correctCount);
                const record = {
                    id: Date.now(), date: new Date().toLocaleString(), config: { ...config },
                    targetItems: targets.map(t => ({ name: t.name, icon: t.icon, id: t.id })),
                    stats: finalStats,
                    selections: selections.map(s => ({ id: s.id, name: s.name, icon: s.icon, isCorrect: targets.some(t => t.id === s.id) }))
                };
                setPracticeHistory(prev => [record, ...prev]);
                setStage(STAGES.RESULT);
            };

            const showHistoryRecord = (record) => {
                setViewingRecord(record);
                setStage(STAGES.RESULT);
            };

            const handleDeleteItem = (categoryId, itemId) => {
                setWordLibrary(prev => prev.map(cat => (cat.category === categoryId ? { ...cat, items: cat.items.filter(item => item.id !== itemId) } : cat)));
            };

            const handleAddNewItem = (e) => {
                e.preventDefault();
                if (!newItem.name.trim()) return;
                const itemToAdd = { id: `custom-${Date.now()}`, name: newItem.name, icon: 'üì¶' };
                setWordLibrary(prev => prev.map(cat => cat.category === newItem.category ? { ...cat, items: [itemToAdd, ...cat.items] } : cat));
                setNewItem({ ...newItem, name: '' });
            };

            useEffect(() => { if (stage === STAGES.DISTRACT) nextDistractor(); }, [stage, nextDistractor]);

            const currentDisplay = viewingRecord ? {
                score: viewingRecord.stats.finalScore, targets: viewingRecord.targetItems, stats: viewingRecord.stats,
                config: viewingRecord.config, selections: viewingRecord.selections, date: viewingRecord.date
            } : {
                score: score, targets: targets, stats: stats, config: config, selections: selections, date: new Date().toLocaleString()
            };

            const getAverageReactionTime = (rTimes) => {
                if (!rTimes || rTimes.length === 0) return "0.000";
                const avgMs = rTimes.reduce((a, b) => a + b, 0) / rTimes.length;
                return (avgMs / 1000).toFixed(3);
            };

            return (
                <div className="app-container">
                    {/* Header - Âõ∫ÂÆö */}
                    <header className="bg-white border-b border-slate-100 p-4 md:p-6 flex justify-between items-center shrink-0 shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-600 rounded-xl text-white shadow-md">
                                <Icon name="brain" size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl md:text-2xl font-black tracking-tight text-slate-900">Âª∂ÈÅ≤Ë®òÊÜ∂Áéã</h1>
                                <p className="hidden md:block text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cognitive Mastery Pro</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {(stage === STAGES.MEMORIZE || stage === STAGES.DISTRACT || stage === STAGES.RECALL) && (
                                <button onClick={() => setShowAbortModal(true)} className="flex items-center gap-1 bg-red-50 text-red-500 hover:bg-red-100 px-3 py-2 rounded-xl text-xs font-bold border border-red-100 transition-all">
                                    <Icon name="octagon-x" size={16} /> ‰∏≠Êñ∑
                                </button>
                            )}
                            <button onClick={() => setStage(STAGES.HISTORY)} className="p-2 bg-slate-50 text-slate-500 hover:bg-indigo-50 rounded-xl border border-slate-100">
                                <Icon name="history" size={20} />
                            </button>
                            <button onClick={() => setShowPool(true)} className="flex items-center gap-2 bg-slate-50 text-slate-500 hover:bg-indigo-50 px-3 py-2 rounded-xl text-xs font-bold border border-slate-100">
                                <Icon name="package" size={18} /> ÁÆ°ÁêÜÈ°åÂ∫´
                            </button>
                        </div>
                    </header>

                    {/* Main Content - ÂèØÊªæÂãï */}
                    <main className="main-content custom-scrollbar px-4 md:px-10 py-6">
                        <div className="max-w-3xl mx-auto w-full">
                            
                            {stage === STAGES.START && (
                                <div className="animate-in fade-in zoom-in duration-500 text-center">
                                    <div className="mb-8">
                                        <div className="inline-block mb-3 px-3 py-0.5 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-black tracking-widest">DAILY TRAINING</div>
                                        <h2 className="text-3xl md:text-4xl font-black text-slate-900 mb-2">Ë®ìÁ∑¥Â§ßËÖ¶</h2>
                                        <p className="text-slate-400 text-sm">ËÅ∑ËÉΩÊ≤ªÁôÇÂ∞àÊ•≠Ë™çÁü•Âº∑ÂåñÁ≥ªÁµ±</p>
                                    </div>

                                    <div className="space-y-4 mb-10">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-white p-4 rounded-3xl border-2 border-slate-100 flex flex-col items-center shadow-sm">
                                                <div className="flex items-center gap-2 mb-3 text-indigo-500"><Icon name="target" size={18} /><span className="text-xs font-black text-slate-400">Áâ©ÂìÅÊï∏Èáè</span></div>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => updateConfig('targetCount', Math.max(1, config.targetCount - 1))} className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-90"><Icon name="minus" size={14} /></button>
                                                    <span className="text-2xl font-black">{config.targetCount}</span>
                                                    <button onClick={() => updateConfig('targetCount', Math.min(10, config.targetCount + 1))} className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-90"><Icon name="plus" size={14} /></button>
                                                </div>
                                            </div>
                                            <div className="bg-white p-4 rounded-3xl border-2 border-slate-100 flex flex-col items-center shadow-sm">
                                                <div className="flex items-center gap-2 mb-3 text-amber-500"><Icon name="layers" size={18} /><span className="text-xs font-black text-slate-400">Ê∑∑Ê∑ÜÊï∏Èáè</span></div>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.max(0, config.recallDistractorCount - 1))} className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-90"><Icon name="minus" size={14} /></button>
                                                    <span className="text-2xl font-black">{config.recallDistractorCount}</span>
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.min(15, config.recallDistractorCount + 1))} className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-90"><Icon name="plus" size={14} /></button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white p-5 rounded-3xl border-2 border-slate-100 shadow-sm text-left">
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center gap-2"><Icon name="zap" size={16} className="text-indigo-600" /><span className="text-sm font-black">‰ªªÂãôÂàáÊèõÊ®°Âºè</span></div>
                                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={() => updateConfig('distractorMode', 'count')} className={`px-3 py-1 rounded font-bold text-[10px] transition-all ${config.distractorMode === 'count' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}>Ê¨°Êï∏</button>
                                                    <button onClick={() => updateConfig('distractorMode', 'time')} className={`px-3 py-1 rounded font-bold text-[10px] transition-all ${config.distractorMode === 'time' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}>Ë®àÊôÇ</button>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-center gap-6">
                                                <span className="text-xs font-bold text-slate-400 uppercase tracking-tighter">{config.distractorMode === 'count' ? 'ÁõÆÊ®ôÁ≠îÂ∞çÈ°åÊï∏' : 'ÊåëÊà∞Á∏ΩÁßíÊï∏'}</span>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.max(1, config.distractorTarget - 1)) : updateConfig('distractorDuration', Math.max(10, config.distractorDuration - 10))} className="w-10 h-10 rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="minus" size={16} /></button>
                                                    <span className="text-2xl font-black text-indigo-700 min-w-[40px] text-center">{config.distractorMode === 'count' ? config.distractorTarget : config.distractorDuration}</span>
                                                    <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.min(50, config.distractorTarget + 1)) : updateConfig('distractorDuration', Math.min(120, config.distractorDuration + 10))} className="w-10 h-10 rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="plus" size={16} /></button>
                                                </div>
                                            </div>
                                        </div>

                                        <button onClick={() => updateConfig('showIcons', !config.showIcons)} className={`w-full p-5 rounded-3xl border-2 transition-all flex items-center justify-between shadow-sm ${config.showIcons ? 'bg-indigo-50/50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-100 text-slate-400'}`}>
                                            <div className="flex items-center gap-3"><Icon name={config.showIcons ? "eye" : "eye-off"} size={20}/><span className="text-sm md:text-base font-black">ÂúñÁâáËºîÂä©Ê®°Âºè</span></div>
                                            <div className={`w-10 h-5 rounded-full relative transition-colors ${config.showIcons ? 'bg-indigo-600' : 'bg-slate-300'}`}><div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full transition-all ${config.showIcons ? 'left-5.5' : 'left-0.5'}`}></div></div>
                                        </button>
                                    </div>

                                    <button onClick={startGame} className="w-full max-w-sm mx-auto block bg-slate-900 hover:bg-black text-white text-xl font-black py-5 rounded-[2rem] shadow-xl transition-all active:scale-95 group">
                                        <div className="flex items-center justify-center gap-2">ÂïüÂãïË®ìÁ∑¥Â§ßËÖ¶ <Icon name="arrow-right" className="group-hover:translate-x-2 transition-transform" /></div>
                                    </button>
                                </div>
                            )}

                            {stage === STAGES.MEMORIZE && (
                                <div className="animate-in slide-in-from-right duration-500 text-center flex flex-col h-full">
                                    <div className="shrink-0 mb-6">
                                        <div className="inline-flex items-center gap-3 px-6 py-2 bg-indigo-50 border-2 border-indigo-100 rounded-full mb-3 text-indigo-600 font-mono text-2xl font-black shadow-sm">
                                            <Icon name="timer" size={20} /> {memoryStopwatch}
                                        </div>
                                        <h3 className="text-2xl font-black text-slate-900 mb-1">Ë´ãË®ò‰Ωè‰ª•‰∏ãÁâ©ÂìÅ</h3>
                                        <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">È°ûÂà•Ôºö{currentSet?.category}</p>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-5 mb-8">
                                        {targets.map(item => (
                                            <div key={item.id} className="bg-white border-2 border-slate-100 rounded-3xl p-4 md:p-6 text-center shadow-sm flex flex-col items-center justify-center min-h-[120px] md:min-h-[160px]">
                                                {config.showIcons && <div className="text-5xl md:text-6xl mb-3">{item.icon}</div>}
                                                <div className={`font-black text-slate-800 ${config.showIcons ? 'text-lg md:text-2xl' : 'text-3xl md:text-4xl'}`}>{item.name}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-auto shrink-0">
                                        <button onClick={finishMemorize} className="w-full max-w-sm mx-auto block bg-indigo-600 text-white text-xl font-black py-5 rounded-3xl shadow-lg active:scale-95 transition-all">Ë®òÂ•Ω‰∫ÜÔºåÊåëÊà∞ÈñãÂßã</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.DISTRACT && (
                                <div className="text-center animate-in fade-in duration-300 h-full flex flex-col">
                                    <div className="shrink-0 flex justify-center mb-6">
                                        <div className={`px-6 py-2 bg-white border-2 rounded-full text-lg font-black shadow-sm ${config.distractorMode === 'count' ? 'border-amber-200 text-amber-600' : 'border-red-200 text-red-500'}`}>
                                            {config.distractorMode === 'count' ? `Â∑≤Á≠îÂ∞çÔºö${stats.distractorCorrect} / ${config.distractorTarget}` : `ÊôÇÈñìÔºö${timerLeft} Áßí`}
                                        </div>
                                    </div>
                                    <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-6">ÊñáÂ≠ó Ëàá È°èËâ≤ ÊòØÂê¶‰∏ÄËá¥Ôºü</h3>
                                    
                                    <div className={`mb-8 flex-1 flex flex-col items-center justify-center bg-white rounded-[3rem] border-4 transition-all relative shadow-inner min-h-[250px] ${lastFeedback === 'correct' ? 'border-green-400 bg-green-50/20' : lastFeedback === 'wrong' ? 'border-red-400 bg-red-50/20 shake' : 'border-slate-50'}`}>
                                        <span className="text-[5.5rem] md:text-[8rem] font-black tracking-widest" style={{ color: distractorTask.color }}>{distractorTask.word}</span>
                                        {lastFeedback === 'correct' && <div className="absolute top-6 right-6 text-green-500"><Icon name="check-circle-2" size={48} /></div>}
                                        {lastFeedback === 'wrong' && <div className="absolute top-6 right-6 text-red-500"><Icon name="x" size={48} /></div>}
                                    </div>

                                    <div className="grid grid-cols-2 gap-5 md:gap-8 max-w-lg mx-auto w-full shrink-0">
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(true)} className="bg-green-500 hover:bg-green-600 text-white py-8 md:py-10 rounded-3xl text-4xl font-black shadow-lg active:scale-95 disabled:opacity-50 transition-all">ÊòØ</button>
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(false)} className="bg-red-500 hover:bg-red-600 text-white py-8 md:py-10 rounded-3xl text-4xl font-black shadow-lg active:scale-95 disabled:opacity-50 transition-all">Âê¶</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.RECALL && (
                                <div className="animate-in fade-in duration-500 text-center flex flex-col h-full">
                                    <h3 className="text-2xl font-black text-slate-900 mb-6">Âª∂ÈÅ≤ÂõûÊÜ∂ÊåëÊà∞</h3>
                                    <div className="flex justify-center mb-6 shrink-0">
                                        <div className="px-8 py-2 bg-indigo-600 text-white rounded-full font-black text-xl shadow-md ring-4 ring-indigo-50">{selections.length} / {targets.length}</div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 md:gap-4 mb-8">
                                        {options.map(item => {
                                            const isSelected = selections.find(s => s.id === item.id);
                                            return (
                                                <button key={item.id} onClick={() => toggleSelection(item)} className={`relative p-3 md:p-5 rounded-2xl md:rounded-3xl border-2 transition-all flex flex-col items-center justify-center ${isSelected ? 'border-indigo-500 bg-indigo-50 scale-95 shadow-inner' : 'border-slate-100 bg-white hover:border-slate-200 shadow-sm'} ${config.showIcons ? 'h-24 md:h-36' : 'h-16 md:h-24'}`}>
                                                    {config.showIcons && <div className="text-2xl md:text-4xl mb-1">{item.icon}</div>}
                                                    <div className={`font-black text-slate-700 ${config.showIcons ? 'text-xs md:text-lg' : 'text-sm md:text-xl'}`}>{item.name}</div>
                                                    {isSelected && <div className="absolute top-1 right-1 bg-indigo-500 text-white rounded-full p-0.5"><Icon name="check-circle-2" size={14} /></div>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-auto shrink-0">
                                        <button onClick={finishGame} disabled={selections.length < targets.length} className={`w-full max-w-sm mx-auto block py-5 rounded-3xl text-lg font-black shadow-xl active:scale-95 transition-all ${selections.length < targets.length ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-900 text-white'}`}>{selections.length < targets.length ? `ÈÇÑÂ∑Æ ${targets.length - selections.length} ÂÄãÁ≠îÊ°à` : 'ÂÆåÊàê‰∏¶Êü•ÁúãÂ†±Âëä'}</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.RESULT && (
                                <div className="animate-in zoom-in duration-500 text-center flex flex-col h-full">
                                    <div className="mb-6 shrink-0">
                                        <div className="inline-block p-3 bg-slate-50 border rounded-2xl text-indigo-600 mb-2 shadow-sm"><Icon name="file-text" size={32}/></div>
                                        <h3 className="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">Ë®ìÁ∑¥Â†±Âëä</h3>
                                        <p className="text-[10px] text-slate-400 font-bold">{currentDisplay.date}</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div className="bg-white rounded-[2rem] p-6 border-2 border-slate-50 shadow-sm text-center flex flex-col justify-center min-h-[180px]">
                                            <p className="text-slate-400 font-black text-[10px] uppercase mb-1">ÂõûÊÜ∂Ê∫ñÁ¢∫Áéá</p>
                                            <div className="text-6xl md:text-7xl font-black text-slate-900 leading-none mb-4">{Math.round((currentDisplay.score / currentDisplay.targets.length) * 100)}<span className="text-lg">%</span></div>
                                            <div className="flex justify-center gap-2">{currentDisplay.targets.map((t, idx) => (<div key={idx} className={`w-3 h-3 rounded-full ${currentDisplay.selections.some(s => s.id === t.id) ? 'bg-green-500' : 'bg-red-400'}`}></div>))}</div>
                                        </div>
                                        <div className="bg-indigo-600 rounded-[2rem] p-6 text-white shadow-lg space-y-3 text-sm flex flex-col justify-center text-left">
                                            <div className="flex justify-between border-b border-indigo-400 pb-1"><span>Ë®òÊÜ∂ËÄóÊôÇ</span><span className="font-bold">{currentDisplay.stats.memoryTime} s</span></div>
                                            <div className="flex justify-between border-b border-indigo-400 pb-1"><span>Âπ≤ÊìæÁ≠îÂ∞ç</span><span className="font-bold">{currentDisplay.stats.distractorCorrect} È°å</span></div>
                                            <div className="flex justify-between border-b border-indigo-400 pb-1"><span>Ê≠£Á¢∫Áéá</span><span className="font-bold">{Math.round((currentDisplay.stats.distractorCorrect / currentDisplay.stats.distractorTotal) * 100 || 0)}%</span></div>
                                            <div className="flex justify-between border-b border-indigo-400 pb-1"><span>ÂèçÊáâÈÄüÂ∫¶</span><span className="font-bold">{getAverageReactionTime(currentDisplay.stats.reactionTimes)} s</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 rounded-[2rem] p-5 mb-8 text-left max-h-[150px] overflow-y-auto custom-scrollbar shadow-inner">
                                        <div className="text-[10px] font-black text-slate-400 uppercase mb-3 px-1">Ë®òÊÜ∂Ê∏ÖÂñÆ</div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                            {currentDisplay.targets.map(t => (
                                                <div key={t.id} className="flex items-center gap-2 px-3 py-2 bg-white rounded-xl border border-slate-100 shadow-sm text-xs">
                                                    <span>{t.icon}</span>
                                                    <span className="flex-1 font-black text-slate-600 truncate">{t.name}</span>
                                                    {currentDisplay.selections.some(s => s.id === t.id) ? <Icon name="check-circle-2" size={14} className="text-green-500" /> : <Icon name="x" size={14} className="text-red-400" />}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-3 mt-auto shrink-0">
                                        <button onClick={() => { setViewingRecord(null); setStage(STAGES.START); }} className="flex-1 bg-slate-900 text-white py-4 md:py-5 rounded-2xl text-base font-black shadow-md active:scale-95 transition-all">‰∏ªÁï´Èù¢</button>
                                        <button onClick={() => setStage(STAGES.HISTORY)} className="flex-1 bg-white border border-slate-200 text-slate-600 py-4 md:py-5 rounded-2xl text-base font-black shadow-sm transition-all">Ê≠∑Âè≤ÊàêÁ∏æ</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.HISTORY && (
                                <div className="animate-in fade-in duration-400 flex flex-col h-full">
                                    <div className="flex justify-between items-center mb-6 shrink-0"><h3 className="text-xl font-black text-slate-900 flex items-center gap-3"><Icon name="history" size={24} className="text-indigo-600" /> Ê≠∑Âè≤Ë®ìÁ∑¥Á¥ÄÈåÑ</h3><button onClick={() => setStage(STAGES.START)}><Icon name="x" size={28} className="text-slate-400"/></button></div>
                                    <div className="space-y-3 flex-1 overflow-y-auto pr-1 custom-scrollbar">
                                        {practiceHistory.length === 0 ? <div className="text-center py-20 bg-slate-100 rounded-3xl text-slate-400 text-sm font-black">ÁõÆÂâçÂ∞öÊú™ÊúâË®ìÁ∑¥Êï∏Êìö</div> : 
                                            practiceHistory.map(record => (
                                                <button key={record.id} onClick={() => showHistoryRecord(record)} className="w-full bg-white border border-slate-100 p-4 rounded-2xl flex justify-between items-center hover:border-indigo-300 transition-all text-left shadow-sm group">
                                                    <div className="flex-1 min-w-0 mr-3">
                                                        <div className="text-[10px] font-black text-slate-300 uppercase mb-1">{record.date.split(' ')[0]}</div>
                                                        <div className="text-sm font-black text-slate-800 group-hover:text-indigo-700 transition-colors truncate">Ë®òÊÜ∂ {record.config.targetCount} È†ÖÊåëÊà∞</div>
                                                        <div className="text-[10px] text-slate-400 font-bold">ËÄóÊôÇÔºö{record.stats.memoryTime} Áßí</div>
                                                    </div>
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <div className="text-right">
                                                            <div className="text-xl md:text-2xl font-black text-indigo-600">{Math.round((record.stats.finalScore / record.config.targetCount) * 100)}%</div>
                                                        </div>
                                                        <Icon name="chevron-right" className="text-slate-200" size={20} />
                                                    </div>
                                                </button>
                                            ))
                                        }
                                    </div>
                                    <button onClick={() => setStage(STAGES.START)} className="w-full mt-4 shrink-0 bg-slate-900 text-white py-4 rounded-2xl font-black shadow-md">ÂõûÂà∞‰∏ªÁï´Èù¢</button>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Footer - Âõ∫ÂÆö */}
                    <footer className="bg-white border-t border-slate-100 p-4 md:p-5 shrink-0 z-10 text-center">
                        <div className="flex justify-center gap-6 text-slate-400 text-[10px] font-black uppercase tracking-widest mb-3">
                            <div className="flex items-center gap-1"><Icon name="home" size={12}/> Living</div>
                            <div className="flex items-center gap-1"><Icon name="brain" size={12}/> Memory</div>
                            <div className="flex items-center gap-1"><Icon name="eye" size={12}/> Cognitive</div>
                        </div>
                        <p className="text-slate-400 text-[11px] md:text-xs font-bold border-t border-slate-50 pt-3">
                            Ë®≠Ë®àÔºö<a href="https://www.facebook.com/mpotkevin" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 transition-colors underline decoration-indigo-200 underline-offset-4 decoration-2 font-bold uppercase tracking-tight">ËÅ∑ËÉΩÊ≤ªÁôÇÂ∏´ - ÈÑ≠Âá±Êñá</a>
                        </p>
                    </footer>

                    {/* Modals & Popups */}
                    {showAbortModal && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm p-4 flex items-center justify-center animate-in fade-in duration-200">
                            <div className="bg-white rounded-[2.5rem] p-6 md:p-8 max-w-sm w-full shadow-2xl text-center animate-in zoom-in duration-300">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="alert-triangle" size={32} />
                                </div>
                                <h4 className="text-xl font-black text-slate-800 mb-2">‰∏≠Êñ∑Ë®ìÁ∑¥Ôºü</h4>
                                <p className="text-slate-400 text-sm mb-6 font-medium">ÁõÆÂâçÁöÑÈÄ≤Â∫¶Â∞áÊúÉÈÅ∫Â§±„ÄÇ</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowAbortModal(false)} className="flex-1 py-3.5 bg-slate-100 text-slate-600 rounded-xl font-black transition-all">ÂèñÊ∂à</button>
                                    <button onClick={resetAllStates} className="flex-1 py-3.5 bg-red-500 text-white rounded-xl font-black shadow-lg shadow-red-100 transition-all">Á¢∫ÂÆö</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showPool && (
                        <div className="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-xl p-4 flex items-center justify-center">
                            <div className="bg-white w-full max-w-xl max-h-[85vh] rounded-[3rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in duration-300">
                                <div className="p-6 bg-slate-50 border-b flex justify-between items-center shrink-0">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-white rounded-xl text-indigo-600 shadow-sm"><Icon name="package" size={24} /></div>
                                        <h4 className="text-lg font-black text-slate-900">È°åÂ∫´ÁÆ°ÁêÜ</h4>
                                    </div>
                                    <button onClick={() => setShowPool(false)} className="p-2 text-slate-400"><Icon name="x" size={24} /></button>
                                </div>
                                <div className="p-6 bg-white border-b shrink-0">
                                    <form onSubmit={handleAddNewItem} className="flex gap-2">
                                        <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="Êñ∞Â¢ûÁâ©ÂìÅ..." className="flex-1 px-4 py-3 border-2 border-slate-100 rounded-xl text-sm font-bold bg-slate-50/50 outline-none focus:border-indigo-400" />
                                        <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} className="px-3 py-3 border-2 border-slate-100 rounded-xl text-xs font-bold bg-slate-50/50 text-slate-500">
                                            {wordLibrary.map(cat => <option key={cat.category} value={cat.category}>{cat.category}</option>)}
                                        </select>
                                        <button type="submit" className="bg-slate-900 text-white px-5 rounded-xl font-black text-xs active:scale-95 shadow-md">Êñ∞Â¢û</button>
                                    </form>
                                </div>
                                <div className="p-6 overflow-y-auto space-y-8 bg-slate-50/20 custom-scrollbar flex-1">
                                    {wordLibrary.map(set => (
                                        <div key={set.category}>
                                            <h5 className="font-black text-slate-900 mb-4 flex items-center gap-2 text-sm"><div className="w-1.5 h-4 bg-indigo-500 rounded-full"></div>{set.category}</h5>
                                            <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
                                                {set.items.map(item => (
                                                    <div key={item.id} className="group relative p-3 bg-white rounded-2xl text-center border border-slate-100 shadow-sm">
                                                        <button onClick={() => handleDeleteItem(set.category, item.id)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={10} /></button>
                                                        <div className="text-2xl mb-1">{typeof item.icon === 'string' ? item.icon : 'üì¶'}</div>
                                                        <div className="text-[10px] font-black text-slate-500 truncate">{item.name}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
